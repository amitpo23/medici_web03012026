<div class="logs-viewer-container">
  <!-- Navigation Bar -->
  <div class="nav-bar">
    <button class="back-button" (click)="goBack()">
      <span class="icon">â†</span>
      ×—×–×¨×” ×œ××¨×›×– ×”××¢×¨×›×•×ª
    </button>
    <div class="breadcrumb">
      <span class="breadcrumb-item">××¢×¨×›×•×ª × ×™×˜×•×¨</span>
      <span class="separator">â€º</span>
      <span class="breadcrumb-item current">×¦×¤×™×™×” ×‘×œ×•×’×™×</span>
    </div>
  </div>

  <!-- Header -->
  <div class="page-header">
    <h1>ğŸ“‹ ××¢×¨×›×ª ×¦×¤×™×™×” ×‘×œ×•×’×™×</h1>
    <p class="subtitle">××¢×§×‘ ×•×—×™×¤×•×© ×‘×›×œ ×§×¨×™××•×ª ×”-API ×•×¤×¢×•×œ×•×ª ×”××¢×¨×›×ª</p>
  </div>

  <!-- Controls Bar -->
  <div class="controls-bar">
    <!-- File Selector -->
    <div class="control-group">
      <label for="file-select">×§×•×‘×¥ ×œ×•×’:</label>
      <select 
        id="file-select" 
        [(ngModel)]="selectedFile" 
        (change)="onFileSelect()"
        [disabled]="filesLoading">
        <option value="">×‘×—×¨ ×§×•×‘×¥ ×œ×•×’...</option>
        <option *ngFor="let file of logFiles" [value]="file.name">
          {{ file.name }} ({{ file.size }})
        </option>
      </select>
    </div>

    <!-- Lines Limit -->
    <div class="control-group">
      <label for="lines-limit">×©×•×¨×•×ª:</label>
      <select id="lines-limit" [(ngModel)]="maxLines" (change)="loadLogFile()">
        <option [value]="50">50</option>
        <option [value]="100">100</option>
        <option [value]="200">200</option>
        <option [value]="500">500</option>
        <option [value]="1000">1000</option>
      </select>
    </div>

    <!-- Auto Refresh -->
    <div class="control-group">
      <button 
        class="btn-toggle" 
        [class.active]="autoRefresh"
        (click)="toggleAutoRefresh()"
        [title]="autoRefresh ? '×¢×¦×•×¨ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™' : '×”×¤×¢×œ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™'">
        {{ autoRefresh ? 'â¸ ×¢×¦×•×¨' : 'â–¶ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™' }}
      </button>
    </div>

    <!-- Actions -->
    <div class="control-group actions">
      <button class="btn-refresh" (click)="refresh()" [disabled]="logsLoading">
        ğŸ”„ ×¨×¢× ×Ÿ
      </button>
      <button class="btn-download" (click)="downloadLogs()">
        ğŸ’¾ ×”×•×¨×“ JSON
      </button>
      <button class="btn-export" (click)="exportToCSV()">
        ğŸ“Š ×™×™×¦× CSV
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab"
      [class.active]="activeTab === 'viewer'"
      (click)="setActiveTab('viewer')">
      ğŸ“‹ ×¦×¤×™×™×” ×‘×œ×•×’×™×
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'search'"
      (click)="setActiveTab('search')">
      ğŸ” ×—×™×¤×•×© ××ª×§×“×
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'stats'"
      (click)="setActiveTab('stats')">
      ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'charts'"
      (click)="setActiveTab('charts')">
      ğŸ“ˆ ×’×¨×¤×™×
    </button>
  </div>

  <!-- Viewer Tab -->
  <div class="tab-content" *ngIf="activeTab === 'viewer'">
    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <input 
          type="text" 
          [(ngModel)]="searchQuery" 
          (input)="onSearchChange()"
          placeholder="ğŸ” ×—×™×¤×•×© ×‘×œ×•×’×™×... (URL, ×©×’×™××”, ×”×•×“×¢×”)"
          class="search-input">
      </div>

      <div class="filter-group">
        <select [(ngModel)]="selectedLevel" (change)="loadLogFile()">
          <option value="">×›×œ ×”×¨××•×ª</option>
          <option value="info">Info</option>
          <option value="warn">Warning</option>
          <option value="error">Error</option>
        </select>
      </div>

      <div class="filter-group">
        <select [(ngModel)]="selectedMethod" (change)="loadLogFile()">
          <option value="">×›×œ ×”××ª×•×“×•×ª</option>
          <option value="GET">GET</option>
          <option value="POST">POST</option>
          <option value="PUT">PUT</option>
          <option value="DELETE">DELETE</option>
        </select>
      </div>

      <div class="filter-group">
        <select [(ngModel)]="selectedStatus" (change)="loadLogFile()">
          <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
          <option value="2xx">2xx - Success</option>
          <option value="3xx">3xx - Redirect</option>
          <option value="4xx">4xx - Client Error</option>
          <option value="5xx">5xx - Server Error</option>
        </select>
      </div>

      <button class="btn-clear" (click)="clearFilters()">
        ğŸ—‘ï¸ × ×§×” ×¡×™× ×•× ×™×
      </button>
    </div>

    <!-- Loading / Error -->
    <div class="loading" *ngIf="logsLoading">×˜×•×¢×Ÿ ×œ×•×’×™×...</div>
    <div class="error" *ngIf="logsError">{{ logsError }}</div>

    <!-- Logs Table -->
    <div class="logs-container" *ngIf="!logsLoading && !logsError">
      <div class="logs-count">
        ××¦×™×’ {{ getFilteredEntries().length }} ×¨×©×•××•×ª
      </div>

      <div class="logs-table-wrapper">
        <table class="logs-table">
          <thead>
            <tr>
              <th style="width: 40px"></th>
              <th style="width: 150px">×–××Ÿ</th>
              <th style="width: 80px">×¨××”</th>
              <th style="width: 80px">Method</th>
              <th>URL / ×”×•×“×¢×”</th>
              <th style="width: 80px">Status</th>
              <th style="width: 100px">×–××Ÿ ×ª×’×•×‘×”</th>
            </tr>
          </thead>
          <tbody>
            <tr 
              *ngFor="let entry of getFilteredEntries()" 
              [class]="getEntryClass(entry)">
              <td class="icon">{{ getEntryIcon(entry) }}</td>
              <td class="timestamp">{{ formatTimestamp(entry.timestamp) }}</td>
              <td class="level">
                <span 
                  class="level-badge" 
                  [style.background]="logsService.getLevelColor(entry.level || 'info')">
                  {{ entry.level || '-' }}
                </span>
              </td>
              <td class="method">
                <span 
                  class="method-badge"
                  *ngIf="entry.method"
                  [style.background]="logsService.getMethodColor(entry.method)">
                  {{ entry.method }}
                </span>
              </td>
              <td class="message">
                <div class="url" *ngIf="entry.url">{{ entry.url }}</div>
                <div class="msg" *ngIf="entry.message && !entry.url">{{ entry.message }}</div>
                <div class="raw" *ngIf="entry.raw">{{ entry.raw }}</div>
              </td>
              <td class="status">
                <span 
                  class="status-badge"
                  *ngIf="entry.status"
                  [style.background]="getStatusCodeColor(entry.status)">
                  {{ entry.status }}
                </span>
              </td>
              <td class="response-time">
                <span 
                  [class.slow]="entry.responseTime && parseInt(entry.responseTime) > 2000">
                  {{ entry.responseTime || '-' }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Search Tab -->
  <div class="tab-content" *ngIf="activeTab === 'search'">
    <div class="search-panel">
      <h3>×—×™×¤×•×© ××ª×§×“× ×‘×›×œ ×”×œ×•×’×™×</h3>
      
      <div class="search-form">
        <div class="form-row">
          <div class="form-group">
            <label>×©××™×œ×ª×ª ×—×™×¤×•×©:</label>
            <input 
              type="text" 
              [(ngModel)]="searchQuery" 
              placeholder="×˜×§×¡×˜ ×œ×—×™×¤×•×©...">
          </div>

          <div class="form-group">
            <label>×¨××ª ×œ×•×’:</label>
            <select [(ngModel)]="advancedSearch.level">
              <option [value]="undefined">×”×›×œ</option>
              <option value="info">Info</option>
              <option value="warn">Warning</option>
              <option value="error">Error</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>××ª××¨×™×š:</label>
            <input 
              type="date" 
              [(ngModel)]="startDate">
          </div>

          <div class="form-group">
            <label>×¢×“ ×ª××¨×™×š:</label>
            <input 
              type="date" 
              [(ngModel)]="endDate">
          </div>

          <div class="form-group">
            <label>××§×¡×™××•× ×ª×•×¦××•×ª:</label>
            <select [(ngModel)]="advancedSearch.limit">
              <option [value]="50">50</option>
              <option [value]="100">100</option>
              <option [value]="200">200</option>
              <option [value]="500">500</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>×©× ××œ×•×Ÿ:</label>
            <input 
              type="text" 
              [(ngModel)]="advancedSearch.hotelName" 
              placeholder="×œ×“×•×’××”: Radisson">
          </div>

          <div class="form-group">
            <label>××–×”×” ×”×–×× ×”:</label>
            <input 
              type="text" 
              [(ngModel)]="advancedSearch.bookingId" 
              placeholder="×œ×“×•×’××”: INN123456">
          </div>
        </div>

        <button 
          class="btn-search" 
          (click)="performAdvancedSearch()"
          [disabled]="searchLoading">
          ğŸ” ×—×¤×©
        </button>
      </div>

      <!-- Search Results -->
      <div class="search-results" *ngIf="searchResults.length > 0">
        <h4>× ××¦××• {{ searchResults.length }} ×ª×•×¦××•×ª:</h4>
        
        <div class="results-list">
          <div 
            class="result-item" 
            *ngFor="let result of searchResults"
            [class]="getEntryClass(result)">
            <div class="result-header">
              <span class="result-icon">{{ getEntryIcon(result) }}</span>
              <span class="result-time">{{ formatTimestamp(result.timestamp) }}</span>
              <span 
                class="result-level"
                [style.background]="logsService.getLevelColor(result.level || 'info')">
                {{ result.level }}
              </span>
              <span 
                class="result-method"
                *ngIf="result.method"
                [style.background]="logsService.getMethodColor(result.method)">
                {{ result.method }}
              </span>
              <span 
                class="result-status"
                *ngIf="result.status"
                [style.background]="getStatusCodeColor(result.status)">
                {{ result.status }}
              </span>
            </div>
            <div class="result-body">
              <div class="result-url" *ngIf="result.url">{{ result.url }}</div>
              <div class="result-message">{{ result.message }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="no-results" *ngIf="!searchLoading && searchResults.length === 0">
        ××™×Ÿ ×ª×•×¦××•×ª ×—×™×¤×•×©. × ×¡×” ×œ×©× ×•×ª ××ª ×”×¤×¨××˜×¨×™×.
      </div>
    </div>
  </div>

  <!-- Stats Tab -->
  <div class="tab-content" *ngIf="activeTab === 'stats'">
    <div class="loading" *ngIf="statsLoading">×˜×•×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª...</div>

    <div class="stats-container" *ngIf="!statsLoading && stats">
      <h3>×¡×˜×˜×™×¡×˜×™×§×•×ª ××¢×¨×›×ª</h3>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-value">{{ stats.totalRequests?.toLocaleString() }}</div>
          <div class="stat-label">×¡×”"×› ×§×¨×™××•×ª</div>
        </div>

        <div class="stat-card error">
          <div class="stat-icon">âŒ</div>
          <div class="stat-value">{{ stats.errorCount?.toLocaleString() }}</div>
          <div class="stat-label">×©×’×™××•×ª</div>
        </div>

        <div class="stat-card" [class.warning]="parseFloat(stats.errorRate) > 5">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-value">{{ stats.errorRate }}</div>
          <div class="stat-label">×©×™×¢×•×¨ ×©×’×™××•×ª</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">â±ï¸</div>
          <div class="stat-value">{{ stats.avgResponseTime }}</div>
          <div class="stat-label">×–××Ÿ ×ª×’×•×‘×” ×××•×¦×¢</div>
        </div>
      </div>

      <div class="slowest-request" *ngIf="stats.slowestRequest">
        <h4>ğŸŒ ×”×§×¨×™××” ×”××™×˜×™×ª ×‘×™×•×ª×¨:</h4>
        <div class="request-details">
          <div><strong>URL:</strong> {{ stats.slowestRequest.url }}</div>
          <div><strong>×–××Ÿ:</strong> {{ stats.slowestRequest.responseTime }}</div>
        </div>
      </div>

      <div class="status-codes" *ngIf="stats.statusCodes">
        <h4>×¤×™×œ×•×— ×œ×¤×™ Status Code:</h4>
        <div class="status-list">
          <div 
            class="status-item" 
            *ngFor="let code of objectKeys(stats.statusCodes)">
            <span 
              class="status-code"
              [style.background]="getStatusCodeColor(parseInt(code))">
              {{ code }}
            </span>
            <span class="status-count">{{ stats.statusCodes[code] }} ×¤×¢××™×</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Tab -->
  <div class="tab-content" *ngIf="activeTab === 'charts'">
    <div class="charts-controls">
      <label for="chart-hours">×ª×§×•×¤×”:</label>
      <select id="chart-hours" [(ngModel)]="chartHours" (change)="onChartHoursChange()">
        <option [value]="6">6 ×©×¢×•×ª</option>
        <option [value]="12">12 ×©×¢×•×ª</option>
        <option [value]="24">24 ×©×¢×•×ª</option>
        <option [value]="48">48 ×©×¢×•×ª</option>
        <option [value]="72">72 ×©×¢×•×ª</option>
      </select>
      <button class="btn-refresh" (click)="loadChartData()" [disabled]="chartsLoading">
        ğŸ”„ ×¨×¢× ×Ÿ
      </button>
    </div>

    <div class="loading" *ngIf="chartsLoading">×˜×•×¢×Ÿ × ×ª×•× ×™ ×’×¨×¤×™×...</div>

    <div class="charts-container" *ngIf="!chartsLoading">
      <!-- Time Series Chart -->
      <div class="chart-card full-width">
        <h4>ğŸ“ˆ ×‘×§×©×•×ª ×•×©×’×™××•×ª ×œ××•×¨×š ×–××Ÿ</h4>
        <div class="chart-wrapper" style="height: 300px;">
          <canvas baseChart
            [data]="timeSeriesChartData"
            [options]="timeSeriesChartOptions"
            type="line">
          </canvas>
        </div>
      </div>

      <div class="charts-row">
        <!-- Status Distribution -->
        <div class="chart-card">
          <h4>ğŸ¯ ×¤×™×œ×•×— Status Codes</h4>
          <div class="chart-wrapper" style="height: 250px;">
            <canvas baseChart
              [data]="statusChartData"
              [options]="statusChartOptions"
              type="doughnut">
            </canvas>
          </div>
        </div>

        <!-- Method Distribution -->
        <div class="chart-card">
          <h4>ğŸ”§ ×¤×™×œ×•×— HTTP Methods</h4>
          <div class="chart-wrapper" style="height: 250px;">
            <canvas baseChart
              [data]="methodChartData"
              [options]="methodChartOptions"
              type="bar">
            </canvas>
          </div>
        </div>
      </div>

      <!-- Response Time Distribution -->
      <div class="chart-card full-width">
        <h4>â±ï¸ ×”×ª×¤×œ×’×•×ª ×–×× ×™ ×ª×’×•×‘×”</h4>
        <div class="chart-wrapper" style="height: 250px;">
          <canvas baseChart
            [data]="responseTimeChartData"
            [options]="responseTimeChartOptions"
            type="bar">
          </canvas>
        </div>
      </div>
    </div>
  </div>
</div>
