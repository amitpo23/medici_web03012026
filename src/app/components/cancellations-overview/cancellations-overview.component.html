<div class="cancellations-container">
  <!-- Header -->
  <div class="page-header">
    <h1>× ×™×ª×•×— ×‘×™×˜×•×œ×™× ğŸš«</h1>
    <p class="subtitle">××¢×§×‘ ×•×¤×™×ª×•×— ×ª×•×‘× ×•×ª ×¢×œ ×›×œ ×”×‘×™×˜×•×œ×™× ×‘××¢×¨×›×ª</p>
  </div>

  <!-- Period Selector -->
  <div class="controls">
    <label for="period-select">×ª×§×•×¤×ª ×–××Ÿ:</label>
    <select id="period-select" [(ngModel)]="selectedPeriod" (change)="onPeriodChange()">
      <option [value]="7">7 ×™××™× ××—×¨×•× ×™×</option>
      <option [value]="30">30 ×™××™× ××—×¨×•× ×™×</option>
      <option [value]="60">60 ×™××™× ××—×¨×•× ×™×</option>
      <option [value]="90">90 ×™××™× ××—×¨×•× ×™×</option>
      <option [value]="180">180 ×™××™× ××—×¨×•× ×™×</option>
    </select>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs">
    <button 
      class="tab" 
      [class.active]="activeTab === 'overview'"
      (click)="setActiveTab('overview')">
      ×¡×§×™×¨×” ×›×œ×œ×™×ª
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'recent'"
      (click)="setActiveTab('recent')">
      ×‘×™×˜×•×œ×™× ××—×¨×•× ×™×
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'errors'"
      (click)="setActiveTab('errors')">
      ×©×’×™××•×ª × ×¤×•×¦×•×ª
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'auto'"
      (click)="setActiveTab('auto')">
      ×‘×™×˜×•×œ×™× ××•×˜×•××˜×™×™×
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'trends'"
      (click)="setActiveTab('trends')">
      ××’××•×ª
    </button>
  </div>

  <!-- Overview Tab -->
  <div class="tab-content" *ngIf="activeTab === 'overview'">
    <div class="loading" *ngIf="statsLoading">×˜×•×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª...</div>
    <div class="error" *ngIf="statsError">{{ statsError }}</div>

    <div class="stats-grid" *ngIf="!statsLoading && !statsError && stats">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-value">{{ formatNumber(stats.totalCancellations) }}</div>
        <div class="stat-label">×¡×”"×› ×‘×™×˜×•×œ×™×</div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">âœ…</div>
        <div class="stat-value">{{ formatNumber(stats.successfulCancellations) }}</div>
        <div class="stat-label">×‘×™×˜×•×œ×™× ××•×¦×œ×—×™×</div>
      </div>

      <div class="stat-card failure">
        <div class="stat-icon">âŒ</div>
        <div class="stat-value">{{ formatNumber(stats.failedCancellations) }}</div>
        <div class="stat-label">×‘×™×˜×•×œ×™× ×›×•×©×œ×™×</div>
      </div>

      <div class="stat-card" [ngClass]="getSuccessRateColor()">
        <div class="stat-icon">ğŸ“ˆ</div>
        <div class="stat-value">{{ stats.successRate }}</div>
        <div class="stat-label">×©×™×¢×•×¨ ×”×¦×œ×—×”</div>
      </div>

      <div class="stat-card auto">
        <div class="stat-icon">ğŸ¤–</div>
        <div class="stat-value">{{ formatNumber(stats.autoCancellations) }}</div>
        <div class="stat-label">×‘×™×˜×•×œ×™× ××•×˜×•××˜×™×™×</div>
      </div>
    </div>
  </div>

  <!-- Recent Cancellations Tab -->
  <div class="tab-content" *ngIf="activeTab === 'recent'">
    <div class="controls">
      <label for="status-filter">×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡:</label>
      <select id="status-filter" [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
        <option value="all">×”×›×œ</option>
        <option value="success">××•×¦×œ×— ×‘×œ×‘×“</option>
        <option value="failure">×›×•×©×œ ×‘×œ×‘×“</option>
      </select>
    </div>

    <div class="loading" *ngIf="recentLoading">×˜×•×¢×Ÿ ×‘×™×˜×•×œ×™× ××—×¨×•× ×™×...</div>
    <div class="error" *ngIf="recentError">{{ recentError }}</div>

    <div class="table-container" *ngIf="!recentLoading && !recentError">
      <table class="cancellations-table">
        <thead>
          <tr>
            <th>×ª××¨×™×š</th>
            <th>×¡×˜×˜×•×¡</th>
            <th>××–×”×” ×”×–×“×× ×•×ª</th>
            <th>××–×”×” ×”×–×× ×”</th>
            <th>××œ×•×Ÿ</th>
            <th>×¡×›×•×</th>
            <th>×¡×™×‘×”/×©×’×™××”</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let cancellation of recentCancellations">
            <td>{{ formatDate(cancellation.DateInsert) }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(cancellation.Status)">
                {{ cancellation.Status === 'SUCCESS' ? 'âœ“ ×”×¦×œ×™×—' : 'âœ— ×›×©×œ' }}
              </span>
            </td>
            <td>{{ cancellation.OpportunityId }}</td>
            <td>{{ cancellation.BookingId }}</td>
            <td>{{ cancellation.HotelName || '×œ× ×™×“×•×¢' }}</td>
            <td>{{ formatCurrency(cancellation.Amount || 0) }}</td>
            <td class="reason">{{ cancellation.CancellationReason || cancellation.ErrorMessage || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Common Errors Tab -->
  <div class="tab-content" *ngIf="activeTab === 'errors'">
    <div class="loading" *ngIf="errorsLoading">×˜×•×¢×Ÿ ×©×’×™××•×ª × ×¤×•×¦×•×ª...</div>
    <div class="error" *ngIf="errorsError">{{ errorsError }}</div>

    <div class="errors-list" *ngIf="!errorsLoading && !errorsError">
      <div class="error-item" *ngFor="let error of commonErrors; let i = index">
        <div class="error-rank">{{ i + 1 }}</div>
        <div class="error-details">
          <div class="error-message">{{ error.ErrorType }}</div>
          <div class="error-meta">
            <span class="error-count">{{ formatNumber(error.Count) }} ×¤×¢××™×</span>
            <span class="error-last">××—×¨×•×Ÿ: {{ formatDate(error.LastOccurrence) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auto Cancellations Tab -->
  <div class="tab-content" *ngIf="activeTab === 'auto'">
    <div class="loading" *ngIf="autoLoading">×˜×•×¢×Ÿ ×‘×™×˜×•×œ×™× ××•×˜×•××˜×™×™×...</div>
    <div class="error" *ngIf="autoError">{{ autoError }}</div>

    <div class="table-container" *ngIf="!autoLoading && !autoError">
      <table class="cancellations-table">
        <thead>
          <tr>
            <th>×ª××¨×™×š</th>
            <th>×¤×¢×•×œ×”</th>
            <th>××–×”×” ×”×–×“×× ×•×ª</th>
            <th>××œ×•×Ÿ</th>
            <th>×ª××¨×™×š ×›× ×™×¡×”</th>
            <th>××—×™×¨ ×¨×›×™×©×”</th>
            <th>×”×—×–×¨/×”×¤×¡×“</th>
            <th>×¤×¨×˜×™×</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let auto of autoCancellations">
            <td>{{ formatDate(auto.date) }}</td>
            <td>
              <span 
                class="status-badge" 
                [ngClass]="auto.actionType === 'AUTO_CANCELLED' ? 'success' : 'failure'">
                {{ auto.actionType === 'AUTO_CANCELLED' ? 'âœ“ ×‘×•×˜×œ ××•×˜×•××˜×™×ª' : 'âœ— ×›×©×œ ×‘×‘×™×˜×•×œ' }}
              </span>
            </td>
            <td>{{ auto.opportunityId }}</td>
            <td>{{ auto.hotelName || '×œ× ×™×“×•×¢' }}</td>
            <td>{{ formatDate(auto.checkIn) }}</td>
            <td>{{ formatCurrency(auto.purchasePrice || 0) }}</td>
            <td [ngClass]="auto.refundAmount > 0 ? 'refund' : 'loss'">
              {{ auto.refundAmount > 0 ? formatCurrency(auto.refundAmount) : formatCurrency(auto.lostAmount) }}
            </td>
            <td class="details">
              <span *ngIf="auto.cancellationId">ID: {{ auto.cancellationId }}</span>
              <span *ngIf="auto.error" class="error-text">{{ auto.error }}</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Trends Tab -->
  <div class="tab-content" *ngIf="activeTab === 'trends'">
    <div class="loading" *ngIf="trendsLoading">×˜×•×¢×Ÿ ××’××•×ª...</div>
    <div class="error" *ngIf="trendsError">{{ trendsError }}</div>

    <div class="trends-container" *ngIf="!trendsLoading && !trendsError && trends">
      <div class="trend-section">
        <h3>×‘×™×˜×•×œ×™× ××•×¦×œ×—×™× ×œ×¤×™ ×™×•×</h3>
        <div class="trend-dates">
          <span *ngFor="let trend of trends.successByDay" class="date-label">
            {{ formatDate(trend.Date).split(' ')[0] }}
          </span>
        </div>
        <div class="trend-chart">
          <div 
            class="trend-bar success" 
            *ngFor="let trend of trends.successByDay"
            [style.height]="getBarHeight(trend.Count, trends.successByDay)"
            [title]="formatDate(trend.Date) + ': ' + trend.Count">
            <span class="bar-label">{{ trend.Count }}</span>
          </div>
        </div>
      </div>

      <div class="trend-section">
        <h3>×‘×™×˜×•×œ×™× ×›×•×©×œ×™× ×œ×¤×™ ×™×•×</h3>
        <div class="trend-dates">
          <span *ngFor="let trend of trends.failureByDay" class="date-label">
            {{ formatDate(trend.Date).split(' ')[0] }}
          </span>
        </div>
        <div class="trend-chart">
          <div 
            class="trend-bar failure" 
            *ngFor="let trend of trends.failureByDay"
            [style.height]="getBarHeight(trend.Count, trends.failureByDay)"
            [title]="formatDate(trend.Date) + ': ' + trend.Count">
            <span class="bar-label">{{ trend.Count }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
