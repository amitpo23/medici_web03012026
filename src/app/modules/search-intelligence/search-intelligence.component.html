<div class="search-intelligence-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <mat-icon>insights</mat-icon>
        Search Intelligence
      </h1>
      <p class="subtitle">Analytics and insights from 8M+ hotel search records</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button class="refresh-btn" (click)="refreshCurrentTab()" type="button">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Tab Group -->
  <mat-tab-group
    [selectedIndex]="selectedTabIndex"
    (selectedIndexChange)="onTabChange($event)"
    class="intelligence-tabs">

    <!-- ============================================ -->
    <!-- Tab 1: Overview -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>dashboard</mat-icon>
        <span>Overview</span>
      </ng-template>
      <div class="tab-panel">
        <div class="loading-overlay" *ngIf="overviewLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading overview...</p>
        </div>

        <div *ngIf="!overviewLoading && overview" class="kpi-grid">
          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper blue">
                <mat-icon>search</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ formatNumber(overview.TotalSearches) }}</span>
                <span class="kpi-label">Total Searches</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper green">
                <mat-icon>hotel</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ formatNumber(overview.UniqueHotels) }}</span>
                <span class="kpi-label">Unique Hotels</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper purple">
                <mat-icon>location_city</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ formatNumber(overview.UniqueCities) }}</span>
                <span class="kpi-label">Unique Cities</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper orange">
                <mat-icon>attach_money</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ formatCurrency(overview.AvgSearchPrice) }}</span>
                <span class="kpi-label">Avg Search Price</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper teal">
                <mat-icon>date_range</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ formatNumber(overview.Last7Days) }}</span>
                <span class="kpi-label">Last 7 Days</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper indigo">
                <mat-icon>calendar_month</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ formatNumber(overview.Last30Days) }}</span>
                <span class="kpi-label">Last 30 Days</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper pink">
                <mat-icon>event</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ formatNumber(overview.ThisMonth) }}</span>
                <span class="kpi-label">This Month</span>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="kpi-card">
            <mat-card-content>
              <div class="kpi-icon-wrapper gray">
                <mat-icon>schedule</mat-icon>
              </div>
              <div class="kpi-details">
                <span class="kpi-value">{{ overview.FirstSearchDate | date:'mediumDate' }}</span>
                <span class="kpi-label">First Search</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div *ngIf="!overviewLoading && !overview" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No overview data available.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 2: Top Cities -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>location_city</mat-icon>
        <span>Top Cities</span>
      </ng-template>
      <div class="tab-panel">
        <div class="tab-toolbar">
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Limit</mat-label>
            <mat-select [(ngModel)]="citiesLimit" (selectionChange)="onCitiesLimitChange()">
              <mat-option [value]="10">10</mat-option>
              <mat-option [value]="20">20</mat-option>
              <mat-option [value]="50">50</mat-option>
              <mat-option [value]="100">100</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="loading-overlay" *ngIf="citiesLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading city data...</p>
        </div>

        <div class="table-container" *ngIf="!citiesLoading && citiesData.length > 0">
          <table mat-table [dataSource]="citiesData" class="mat-elevation-z2 data-table">
            <ng-container matColumnDef="CityName">
              <th mat-header-cell *matHeaderCellDef>City</th>
              <td mat-cell *matCellDef="let row">
                <span class="city-name">{{ row.CityName }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="CountryCode">
              <th mat-header-cell *matHeaderCellDef>Country</th>
              <td mat-cell *matCellDef="let row">{{ row.CountryCode }}</td>
            </ng-container>

            <ng-container matColumnDef="SearchCount">
              <th mat-header-cell *matHeaderCellDef>Searches</th>
              <td mat-cell *matCellDef="let row">
                <strong>{{ row.SearchCount | number }}</strong>
              </td>
            </ng-container>

            <ng-container matColumnDef="Percentage">
              <th mat-header-cell *matHeaderCellDef>Share</th>
              <td mat-cell *matCellDef="let row">
                <div class="percentage-bar-wrapper">
                  <div class="percentage-bar" [style.width.%]="row.Percentage"></div>
                  <span class="percentage-text">{{ row.Percentage | number:'1.2-2' }}%</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="AvgPrice">
              <th mat-header-cell *matHeaderCellDef>Avg Price</th>
              <td mat-cell *matCellDef="let row">{{ formatCurrency(row.AvgPrice) }}</td>
            </ng-container>

            <ng-container matColumnDef="UniqueHotels">
              <th mat-header-cell *matHeaderCellDef>Hotels</th>
              <td mat-cell *matCellDef="let row">{{ row.UniqueHotels | number }}</td>
            </ng-container>

            <ng-container matColumnDef="LastSearched">
              <th mat-header-cell *matHeaderCellDef>Last Searched</th>
              <td mat-cell *matCellDef="let row">{{ row.LastSearched | date:'short' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="citiesColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: citiesColumns;"></tr>
          </table>
        </div>

        <div *ngIf="!citiesLoading && citiesData.length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No city search data available.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 3: Top Hotels -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>hotel</mat-icon>
        <span>Top Hotels</span>
      </ng-template>
      <div class="tab-panel">
        <div class="tab-toolbar">
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Filter by City</mat-label>
            <input matInput [(ngModel)]="hotelCityFilter" placeholder="e.g. London">
          </mat-form-field>
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Limit</mat-label>
            <mat-select [(ngModel)]="hotelsLimit">
              <mat-option [value]="10">10</mat-option>
              <mat-option [value]="20">20</mat-option>
              <mat-option [value]="50">50</mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-flat-button color="primary" (click)="onHotelFilterChange()" type="button">
            <mat-icon>filter_list</mat-icon>
            Apply
          </button>
        </div>

        <div class="loading-overlay" *ngIf="hotelsLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading hotel data...</p>
        </div>

        <div class="table-container" *ngIf="!hotelsLoading && hotelsData.length > 0">
          <table mat-table [dataSource]="hotelsData" class="mat-elevation-z2 data-table">
            <ng-container matColumnDef="HotelName">
              <th mat-header-cell *matHeaderCellDef>Hotel</th>
              <td mat-cell *matCellDef="let row">
                <span class="hotel-name">{{ row.HotelName }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="CityName">
              <th mat-header-cell *matHeaderCellDef>City</th>
              <td mat-cell *matCellDef="let row">{{ row.CityName }}</td>
            </ng-container>

            <ng-container matColumnDef="SearchCount">
              <th mat-header-cell *matHeaderCellDef>Searches</th>
              <td mat-cell *matCellDef="let row">
                <strong>{{ row.SearchCount | number }}</strong>
              </td>
            </ng-container>

            <ng-container matColumnDef="Percentage">
              <th mat-header-cell *matHeaderCellDef>Share</th>
              <td mat-cell *matCellDef="let row">{{ row.Percentage | number:'1.2-2' }}%</td>
            </ng-container>

            <ng-container matColumnDef="AvgPrice">
              <th mat-header-cell *matHeaderCellDef>Avg Price</th>
              <td mat-cell *matCellDef="let row">{{ formatCurrency(row.AvgPrice) }}</td>
            </ng-container>

            <ng-container matColumnDef="AvgStars">
              <th mat-header-cell *matHeaderCellDef>Stars</th>
              <td mat-cell *matCellDef="let row">
                <span class="stars-display">{{ row.AvgStars | number:'1.1-1' }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="LastSearched">
              <th mat-header-cell *matHeaderCellDef>Last Searched</th>
              <td mat-cell *matCellDef="let row">{{ row.LastSearched | date:'short' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="hotelsColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: hotelsColumns;"></tr>
          </table>
        </div>

        <div *ngIf="!hotelsLoading && hotelsData.length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No hotel search data available.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 4: Trends -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>trending_up</mat-icon>
        <span>Trends</span>
      </ng-template>
      <div class="tab-panel">
        <div class="tab-toolbar">
          <mat-button-toggle-group [(ngModel)]="trendsGranularity" (change)="onGranularityChange()">
            <mat-button-toggle value="daily">Daily</mat-button-toggle>
            <mat-button-toggle value="monthly">Monthly</mat-button-toggle>
            <mat-button-toggle value="yearly">Yearly</mat-button-toggle>
          </mat-button-toggle-group>
        </div>

        <div class="loading-overlay" *ngIf="trendsLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading trends...</p>
        </div>

        <div class="table-container" *ngIf="!trendsLoading && trendsData.length > 0">
          <table mat-table [dataSource]="trendsData" class="mat-elevation-z2 data-table">
            <ng-container matColumnDef="Period">
              <th mat-header-cell *matHeaderCellDef>Period</th>
              <td mat-cell *matCellDef="let row">{{ row.Period }}</td>
            </ng-container>

            <ng-container matColumnDef="SearchCount">
              <th mat-header-cell *matHeaderCellDef>Searches</th>
              <td mat-cell *matCellDef="let row; let i = index">
                <div class="trend-cell">
                  <strong>{{ row.SearchCount | number }}</strong>
                  <mat-icon
                    *ngIf="getTrendIndicator(i)"
                    [ngClass]="getTrendClass(i)"
                    class="trend-icon">
                    {{ getTrendIndicator(i) }}
                  </mat-icon>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="UniqueHotels">
              <th mat-header-cell *matHeaderCellDef>Unique Hotels</th>
              <td mat-cell *matCellDef="let row">{{ row.UniqueHotels | number }}</td>
            </ng-container>

            <ng-container matColumnDef="UniqueCities">
              <th mat-header-cell *matHeaderCellDef>Unique Cities</th>
              <td mat-cell *matCellDef="let row">{{ row.UniqueCities | number }}</td>
            </ng-container>

            <ng-container matColumnDef="AvgPrice">
              <th mat-header-cell *matHeaderCellDef>Avg Price</th>
              <td mat-cell *matCellDef="let row">{{ formatCurrency(row.AvgPrice) }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="trendsColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: trendsColumns;"></tr>
          </table>
        </div>

        <div *ngIf="!trendsLoading && trendsData.length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No trend data available.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 5: Prices -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>payments</mat-icon>
        <span>Prices</span>
      </ng-template>
      <div class="tab-panel">
        <div class="loading-overlay" *ngIf="pricesLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading price data...</p>
        </div>

        <div class="table-container" *ngIf="!pricesLoading && pricesData.length > 0">
          <table mat-table [dataSource]="pricesData" class="mat-elevation-z2 data-table">
            <ng-container matColumnDef="Currency">
              <th mat-header-cell *matHeaderCellDef>Currency</th>
              <td mat-cell *matCellDef="let row">
                <span class="currency-badge">{{ row.Currency }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="SearchCount">
              <th mat-header-cell *matHeaderCellDef>Searches</th>
              <td mat-cell *matCellDef="let row">{{ row.SearchCount | number }}</td>
            </ng-container>

            <ng-container matColumnDef="AvgPrice">
              <th mat-header-cell *matHeaderCellDef>Average</th>
              <td mat-cell *matCellDef="let row">{{ row.AvgPrice | number:'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="MinPrice">
              <th mat-header-cell *matHeaderCellDef>Min</th>
              <td mat-cell *matCellDef="let row" class="price-min">{{ row.MinPrice | number:'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="MaxPrice">
              <th mat-header-cell *matHeaderCellDef>Max</th>
              <td mat-cell *matCellDef="let row" class="price-max">{{ row.MaxPrice | number:'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="Q1">
              <th mat-header-cell *matHeaderCellDef>Q1 (25th)</th>
              <td mat-cell *matCellDef="let row">{{ row.Q1 | number:'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="Median">
              <th mat-header-cell *matHeaderCellDef>Median</th>
              <td mat-cell *matCellDef="let row">
                <strong>{{ row.Median | number:'1.2-2' }}</strong>
              </td>
            </ng-container>

            <ng-container matColumnDef="Q3">
              <th mat-header-cell *matHeaderCellDef>Q3 (75th)</th>
              <td mat-cell *matCellDef="let row">{{ row.Q3 | number:'1.2-2' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="pricesColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: pricesColumns;"></tr>
          </table>
        </div>

        <div *ngIf="!pricesLoading && pricesData.length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No price distribution data available.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 6: Seasonality -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>wb_sunny</mat-icon>
        <span>Seasonality</span>
      </ng-template>
      <div class="tab-panel">
        <div class="loading-overlay" *ngIf="seasonalityLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading seasonality data...</p>
        </div>

        <div *ngIf="!seasonalityLoading && seasonalityData" class="seasonality-content">
          <!-- Booking Window Analysis -->
          <h3 class="section-title">
            <mat-icon>schedule</mat-icon>
            Booking Window Analysis (Days Before Stay)
          </h3>
          <div class="table-container" *ngIf="seasonalityData.bookingWindow.length > 0">
            <table mat-table [dataSource]="seasonalityData.bookingWindow" class="mat-elevation-z2 data-table">
              <ng-container matColumnDef="DaysBeforeStay">
                <th mat-header-cell *matHeaderCellDef>Days Before Stay</th>
                <td mat-cell *matCellDef="let row">{{ row.DaysBeforeStay }} days</td>
              </ng-container>

              <ng-container matColumnDef="SearchCount">
                <th mat-header-cell *matHeaderCellDef>Search Count</th>
                <td mat-cell *matCellDef="let row">{{ row.SearchCount | number }}</td>
              </ng-container>

              <ng-container matColumnDef="AvgPrice">
                <th mat-header-cell *matHeaderCellDef>Avg Price</th>
                <td mat-cell *matCellDef="let row">{{ formatCurrency(row.AvgPrice) }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="bookingWindowColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: bookingWindowColumns;"></tr>
            </table>
          </div>

          <!-- Monthly Seasonality -->
          <h3 class="section-title" style="margin-top: 32px;">
            <mat-icon>calendar_month</mat-icon>
            Monthly Demand Patterns
          </h3>
          <div class="monthly-seasonality" *ngIf="seasonalityData.monthlySeasonality.length > 0">
            <div class="month-row" *ngFor="let month of seasonalityData.monthlySeasonality">
              <span class="month-name">{{ month.MonthName }}</span>
              <div class="month-bar-container">
                <div class="month-bar" [style.width.%]="getSeasonalityBarWidth(month)"></div>
              </div>
              <span class="month-count">{{ month.SearchCount | number }}</span>
              <span class="month-price">{{ formatCurrency(month.AvgPrice) }}</span>
            </div>
          </div>
        </div>

        <div *ngIf="!seasonalityLoading && !seasonalityData" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No seasonality data available.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 7: Demand Forecast -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>auto_graph</mat-icon>
        <span>Demand Forecast</span>
      </ng-template>
      <div class="tab-panel">
        <div class="tab-toolbar">
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>City (optional)</mat-label>
            <input matInput [(ngModel)]="forecastCity" placeholder="e.g. Paris">
          </mat-form-field>
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Hotel ID (optional)</mat-label>
            <input matInput type="number" [(ngModel)]="forecastHotelId" placeholder="e.g. 12345">
          </mat-form-field>
          <button mat-flat-button color="primary" (click)="onForecastFilterChange()" type="button">
            <mat-icon>auto_graph</mat-icon>
            Forecast
          </button>
        </div>

        <div class="loading-overlay" *ngIf="forecastLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Generating forecast...</p>
        </div>

        <div *ngIf="!forecastLoading && forecastData" class="forecast-content">
          <!-- Forecast Summary Card -->
          <div *ngIf="forecastData.forecast" class="forecast-summary">
            <mat-card class="forecast-card">
              <mat-card-content>
                <div class="forecast-header">
                  <h3>Demand Forecast</h3>
                  <mat-icon [ngClass]="getForecastTrendClass()" class="forecast-trend-icon">
                    {{ getForecastTrendIcon() }}
                  </mat-icon>
                </div>
                <div class="forecast-metrics">
                  <div class="forecast-metric">
                    <span class="metric-value">{{ forecastData.forecast.nextMonthPrediction | number }}</span>
                    <span class="metric-label">Next Month Prediction</span>
                  </div>
                  <div class="forecast-metric">
                    <span class="metric-value" [ngClass]="getForecastTrendClass()">
                      {{ forecastData.forecast.trendPercent }}
                    </span>
                    <span class="metric-label">Trend ({{ forecastData.forecast.trend }})</span>
                  </div>
                  <div class="forecast-metric">
                    <span class="metric-value">{{ forecastData.forecast.avgMonthlySearches | number }}</span>
                    <span class="metric-label">Avg Monthly Searches</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Historical Data Table -->
          <h3 class="section-title" *ngIf="forecastData.historical.length > 0">
            <mat-icon>history</mat-icon>
            Historical Data
          </h3>
          <div class="table-container" *ngIf="forecastData.historical.length > 0">
            <table mat-table [dataSource]="forecastData.historical" class="mat-elevation-z2 data-table">
              <ng-container matColumnDef="Month">
                <th mat-header-cell *matHeaderCellDef>Month</th>
                <td mat-cell *matCellDef="let row">{{ row.Month }}</td>
              </ng-container>

              <ng-container matColumnDef="SearchCount">
                <th mat-header-cell *matHeaderCellDef>Search Count</th>
                <td mat-cell *matCellDef="let row">{{ row.SearchCount | number }}</td>
              </ng-container>

              <ng-container matColumnDef="AvgPrice">
                <th mat-header-cell *matHeaderCellDef>Avg Price</th>
                <td mat-cell *matCellDef="let row">{{ formatCurrency(row.AvgPrice) }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="forecastColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: forecastColumns;"></tr>
            </table>
          </div>
        </div>

        <div *ngIf="!forecastLoading && !forecastData" class="no-data">
          <mat-icon>info</mat-icon>
          <p>Click "Forecast" to generate demand predictions. Optionally filter by city or hotel.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 8: Real-Time -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>stream</mat-icon>
        <span>Real-Time</span>
      </ng-template>
      <div class="tab-panel">
        <div class="tab-toolbar">
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Results</mat-label>
            <mat-select [(ngModel)]="realTimeLimit" (selectionChange)="onRealTimeLimitChange()">
              <mat-option [value]="25">25</mat-option>
              <mat-option [value]="50">50</mat-option>
              <mat-option [value]="100">100</mat-option>
            </mat-select>
          </mat-form-field>
          <span class="toolbar-info">Last 24 hours of search activity</span>
        </div>

        <div class="loading-overlay" *ngIf="realTimeLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading real-time searches...</p>
        </div>

        <div class="table-container" *ngIf="!realTimeLoading && realTimeData.length > 0">
          <table mat-table [dataSource]="realTimeData" class="mat-elevation-z2 data-table">
            <ng-container matColumnDef="HotelName">
              <th mat-header-cell *matHeaderCellDef>Hotel</th>
              <td mat-cell *matCellDef="let row">{{ row.HotelName }}</td>
            </ng-container>

            <ng-container matColumnDef="CityName">
              <th mat-header-cell *matHeaderCellDef>City</th>
              <td mat-cell *matCellDef="let row">{{ row.CityName }}</td>
            </ng-container>

            <ng-container matColumnDef="StayFrom">
              <th mat-header-cell *matHeaderCellDef>Check-In</th>
              <td mat-cell *matCellDef="let row">{{ row.StayFrom | date:'mediumDate' }}</td>
            </ng-container>

            <ng-container matColumnDef="StayTo">
              <th mat-header-cell *matHeaderCellDef>Check-Out</th>
              <td mat-cell *matCellDef="let row">{{ row.StayTo | date:'mediumDate' }}</td>
            </ng-container>

            <ng-container matColumnDef="PriceAmount">
              <th mat-header-cell *matHeaderCellDef>Price</th>
              <td mat-cell *matCellDef="let row">
                <strong>{{ row.PriceAmount | number:'1.2-2' }}</strong>
              </td>
            </ng-container>

            <ng-container matColumnDef="PriceAmountCurrency">
              <th mat-header-cell *matHeaderCellDef>Currency</th>
              <td mat-cell *matCellDef="let row">
                <span class="currency-badge">{{ row.PriceAmountCurrency }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="RoomType">
              <th mat-header-cell *matHeaderCellDef>Room</th>
              <td mat-cell *matCellDef="let row">{{ row.RoomType }}</td>
            </ng-container>

            <ng-container matColumnDef="Board">
              <th mat-header-cell *matHeaderCellDef>Board</th>
              <td mat-cell *matCellDef="let row">{{ row.Board }}</td>
            </ng-container>

            <ng-container matColumnDef="Stars">
              <th mat-header-cell *matHeaderCellDef>Stars</th>
              <td mat-cell *matCellDef="let row">{{ row.Stars }}</td>
            </ng-container>

            <ng-container matColumnDef="UpdatedAt">
              <th mat-header-cell *matHeaderCellDef>When</th>
              <td mat-cell *matCellDef="let row">
                <span class="time-ago">{{ getTimeAgo(row.UpdatedAt) }}</span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="realTimeColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: realTimeColumns;"></tr>
          </table>
        </div>

        <div *ngIf="!realTimeLoading && realTimeData.length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>No recent searches found in the last 24 hours.</p>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================ -->
    <!-- Tab 9: Conversion -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template matTabLabel>
        <mat-icon>compare_arrows</mat-icon>
        <span>Conversion</span>
      </ng-template>
      <div class="tab-panel">
        <div class="tab-toolbar">
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>City</mat-label>
            <input matInput [(ngModel)]="comparisonCity" placeholder="e.g. Barcelona">
          </mat-form-field>
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Hotel ID</mat-label>
            <input matInput type="number" [(ngModel)]="comparisonHotelId" placeholder="e.g. 12345">
          </mat-form-field>
          <button mat-flat-button color="primary" (click)="loadComparison()" type="button">
            <mat-icon>compare_arrows</mat-icon>
            Compare
          </button>
        </div>

        <div class="comparison-hint" *ngIf="!comparisonData && !comparisonLoading && !comparisonError">
          <mat-icon>info_outline</mat-icon>
          <p>Enter a city name or hotel ID and click "Compare" to see search volume vs actual bookings (last 3 months).</p>
        </div>

        <div class="error-message" *ngIf="comparisonError">
          <mat-icon>error_outline</mat-icon>
          <p>{{ comparisonError }}</p>
        </div>

        <div class="loading-overlay" *ngIf="comparisonLoading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading comparison data...</p>
        </div>

        <div *ngIf="!comparisonLoading && comparisonData" class="comparison-results">
          <div class="comparison-grid">
            <mat-card class="comparison-card search-card">
              <mat-card-content>
                <mat-icon class="comparison-icon">search</mat-icon>
                <span class="comparison-value">{{ comparisonData.searchCount | number }}</span>
                <span class="comparison-label">Total Searches</span>
              </mat-card-content>
            </mat-card>

            <mat-card class="comparison-card booking-card">
              <mat-card-content>
                <mat-icon class="comparison-icon">book_online</mat-icon>
                <span class="comparison-value">{{ comparisonData.bookingCount | number }}</span>
                <span class="comparison-label">Actual Bookings</span>
              </mat-card-content>
            </mat-card>

            <mat-card class="comparison-card conversion-card">
              <mat-card-content>
                <mat-icon class="comparison-icon">percent</mat-icon>
                <span class="comparison-value">{{ comparisonData.conversionRate }}</span>
                <span class="comparison-label">Conversion Rate</span>
              </mat-card-content>
            </mat-card>

            <mat-card class="comparison-card ratio-card">
              <mat-card-content>
                <mat-icon class="comparison-icon">analytics</mat-icon>
                <span class="comparison-value">{{ comparisonData.searchToBookingRatio }}</span>
                <span class="comparison-label">Search-to-Booking Ratio</span>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </div>
    </mat-tab>

  </mat-tab-group>
</div>
