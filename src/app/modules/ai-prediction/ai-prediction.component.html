<div class="ai-prediction-container p-6 space-y-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
        <mat-icon class="text-purple-600">psychology</mat-icon>
        AI Prediction Engine
      </h1>
      <p class="text-gray-500 dark:text-gray-400 mt-1">
        注专转   住住转 注 5 住 AI  转 拽 专
      </p>
      <div class="flex items-center gap-2 mt-2">
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gradient-to-r from-purple-500 to-pink-600 text-white">
           AI Prediction Agents
        </span>
        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gradient-to-r from-blue-500 to-cyan-600 text-white">
           Azure OpenAI + Pinecone
        </span>
      </div>
    </div>
    
    <div class="flex items-center gap-3">
      <button mat-stroked-button color="primary" (click)="clearCache()" matTooltip="拽 ">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-flat-button color="primary" (click)="runFullAnalysis()" [disabled]="isLoading">
        <mat-icon *ngIf="!isLoading">auto_awesome</mat-icon>
        <mat-spinner *ngIf="isLoading" diameter="20" class="inline-block"></mat-spinner>
        <span class="ml-2">驻注 转 </span>
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
    <mat-card class="stat-card">
      <div class="stat-value text-3xl font-bold text-purple-600">{{ analysisStats.totalOpportunities }}</div>
      <div class="stat-label text-gray-500 dark:text-gray-400">转</div>
    </mat-card>
    <mat-card class="stat-card">
      <div class="stat-value text-3xl font-bold text-emerald-600">{{ analysisStats.buyOpportunities }}</div>
      <div class="stat-label text-gray-500 dark:text-gray-400">拽</div>
    </mat-card>
    <mat-card class="stat-card">
      <div class="stat-value text-3xl font-bold text-red-600">{{ analysisStats.sellOpportunities }}</div>
      <div class="stat-label text-gray-500 dark:text-gray-400">专</div>
    </mat-card>
    <mat-card class="stat-card">
      <div class="stat-value text-3xl font-bold text-orange-600">{{ analysisStats.urgentCount }}</div>
      <div class="stat-label text-gray-500 dark:text-gray-400">祝</div>
    </mat-card>
    <mat-card class="stat-card">
      <div class="stat-value text-3xl font-bold text-blue-600">{{ analysisStats.avgConfidence }}%</div>
      <div class="stat-label text-gray-500 dark:text-gray-400"> 爪注</div>
    </mat-card>
  </div>

  <!-- Filters Panel -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-end">
        <!-- City Select -->
        <mat-form-field appearance="outline" class="w-full lg:w-48">
          <mat-label>注专</mat-label>
          <mat-select [formControl]="filtersForm.controls.city">
            <mat-option [value]="null"> 注专</mat-option>
            <mat-option *ngFor="let city of cities" [value]="city.cityName">
              {{ city.cityName }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Hotel Select -->
        <mat-form-field appearance="outline" class="w-full lg:w-64">
          <mat-label></mat-label>
          <mat-select [formControl]="filtersForm.controls.hotelId">
            <mat-option [value]="null"> 转</mat-option>
            <mat-option *ngFor="let hotel of filteredHotels" [value]="hotel.hotelId">
              {{ hotel.hotelName }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Risk Tolerance -->
        <mat-form-field appearance="outline" class="w-full lg:w-36">
          <mat-label>住</mat-label>
          <mat-select [formControl]="filtersForm.controls.riskTolerance">
            <mat-option value="low"></mat-option>
            <mat-option value="medium"></mat-option>
            <mat-option value="high"></mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Days Ahead -->
        <mat-form-field appearance="outline" class="w-full lg:w-36">
          <mat-label> 拽</mat-label>
          <mat-select [formControl]="filtersForm.controls.futureDays">
            <mat-option [value]="7">砖注</mat-option>
            <mat-option [value]="14">砖注</mat-option>
            <mat-option [value]="30">砖</mat-option>
            <mat-option [value]="60">砖</mat-option>
            <mat-option [value]="90">专注</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Clear Button -->
        <button mat-stroked-button (click)="clearFilters()" class="lg:mb-1">
          <mat-icon>clear</mat-icon>
          拽
        </button>
      </div>

      <!-- User Instructions -->
      <div class="mt-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>转 转转 砖转 (注专转  转)</mat-label>
          <textarea matInput [formControl]="filtersForm.controls.userInstructions" rows="2"
            placeholder=": 专 注 100 专 注 专 砖 驻转 15%"></textarea>
          <mat-icon matSuffix>edit_note</mat-icon>
        </mat-form-field>
        
        <!-- Advanced Profit Filters -->
        <mat-expansion-panel class="mt-3">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="mr-2">filter_list</mat-icon>
              驻专 转拽 (专转)
            </mat-panel-title>
          </mat-expansion-panel-header>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-3">
            <!-- Minimum Profit -->
            <mat-form-field appearance="outline">
              <mat-label>专  ($)</mat-label>
              <input matInput type="number" [formControl]="filtersForm.controls.minProfit" placeholder="100">
              <mat-icon matPrefix>attach_money</mat-icon>
            </mat-form-field>

            <!-- Minimum Margin % -->
            <mat-form-field appearance="outline">
              <mat-label>专  (%)</mat-label>
              <input matInput type="number" [formControl]="filtersForm.controls.minMarginPercent" placeholder="15">
              <mat-icon matPrefix>percent</mat-icon>
            </mat-form-field>

            <!-- Minimum ROI % -->
            <mat-form-field appearance="outline">
              <mat-label>ROI  (%)</mat-label>
              <input matInput type="number" [formControl]="filtersForm.controls.minROI" placeholder="20">
              <mat-icon matPrefix>trending_up</mat-icon>
            </mat-form-field>

            <!-- Days to Check-in -->
            <mat-form-field appearance="outline">
              <mat-label> 注 爪'拽-</mat-label>
              <input matInput type="number" [formControl]="filtersForm.controls.daysToCheckIn" placeholder="30">
              <mat-icon matPrefix>calendar_today</mat-icon>
            </mat-form-field>

            <!-- Season Filter -->
            <mat-form-field appearance="outline">
              <mat-label>注</mat-label>
              <mat-select [formControl]="filtersForm.controls.season">
                <mat-option [value]="null"> 注转</mat-option>
                <mat-option value="summer">拽抓</mat-option>
                <mat-option value="winter">专祝</mat-option>
                <mat-option value="spring"></mat-option>
                <mat-option value="fall">住转</mat-option>
              </mat-select>
              <mat-icon matPrefix>wb_sunny</mat-icon>
            </mat-form-field>

            <!-- Checkboxes -->
            <div class="flex flex-col gap-2">
              <mat-checkbox [formControl]="filtersForm.controls.weekendOnly">
                住驻"砖 
              </mat-checkbox>
              <mat-checkbox [formControl]="filtersForm.controls.freeCancellationOnly">
                  
              </mat-checkbox>
            </div>
          </div>
        </mat-expansion-panel>
        
        <!-- Example Instructions -->
        <div class="flex flex-wrap gap-2 mt-3">
          <span class="text-sm text-gray-500 dark:text-gray-400">转:</span>
          <button *ngFor="let example of exampleInstructions" 
                  mat-stroked-button 
                  class="example-btn text-xs"
                  (click)="applyExample(example)">
            {{ example }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabs -->
  <mat-tab-group (selectedIndexChange)="onTabChange($event)" animationDuration="200ms">
    <!-- Opportunities Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">lightbulb</mat-icon>
        转
        <span *ngIf="opportunities.length > 0" class="ml-2 px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 text-xs dark:bg-purple-900/30 dark:text-purple-400">
          {{ opportunities.length }}
        </span>
      </ng-template>
      
      <div class="py-4">
        <!-- Zenith Push Actions Bar -->
        <div *ngIf="opportunities.length > 0" class="mb-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
          <div class="flex items-center gap-3">
            <mat-checkbox [(ngModel)]="selectAllOpportunities" (ngModelChange)="onSelectAll($event)">
              专 
            </mat-checkbox>
            <span class="text-sm text-gray-600 dark:text-gray-400">
              <strong>{{ selectedOpportunitiesCount }}</strong> 专 转 {{ opportunities.length }}
            </span>
          </div>
          
          <div class="flex items-center gap-2">
            <button mat-flat-button 
                    color="accent" 
                    [disabled]="selectedOpportunitiesCount === 0 || isPushingToZenith"
                    (click)="openZenithPushDialog()">
              <mat-icon>cloud_upload</mat-icon>
              <span class="ml-2">祝 -Zenith ({{ selectedOpportunitiesCount }})</span>
            </button>
            <button mat-stroked-button 
                    color="warn" 
                    [disabled]="selectedOpportunitiesCount === 0"
                    (click)="clearSelection()">
              <mat-icon>clear</mat-icon>
              拽 专
            </button>
          </div>
        </div>

        <div *ngIf="isLoadingOpportunities" class="flex justify-center items-center py-12">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        
        <div *ngIf="!isLoadingOpportunities && opportunities.length === 0" class="text-center py-12">
          <mat-icon class="text-6xl text-gray-300 dark:text-gray-600">search_off</mat-icon>
          <p class="text-gray-500 dark:text-gray-400 mt-4"> 爪 转 转转</p>
          <p class="text-gray-400 dark:text-gray-500 text-sm mt-2">住 砖转 转 驻专  专抓 转 </p>
        </div>

        <div *ngIf="!isLoadingOpportunities && opportunities.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <app-opportunity-card *ngFor="let opp of opportunities" [opportunity]="opp"></app-opportunity-card>
        </div>
      </div>
    </mat-tab>

    <!-- Agent Status Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">smart_toy</mat-icon>
        住 AI
      </ng-template>
      
      <div class="py-4">
        <app-agent-status [status]="agentStatus"></app-agent-status>
      </div>
    </mat-tab>

    <!-- Market Analysis Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">analytics</mat-icon>
        转 砖拽
      </ng-template>
      
      <div class="py-4">
        <app-market-analysis 
          [city]="filtersForm.controls.city.value"
          [hotelId]="filtersForm.controls.hotelId.value">
        </app-market-analysis>
      </div>
    </mat-tab>

    <!-- Demand Forecast Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">trending_up</mat-icon>
         拽砖
      </ng-template>
      
      <div class="py-4">
        <app-demand-forecast 
          [city]="filtersForm.controls.city.value"
          [hotelId]="filtersForm.controls.hotelId.value"
          [days]="filtersForm.controls.futureDays.value || 30">
        </app-demand-forecast>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Analysis Result Summary -->
  <mat-card *ngIf="analysisResult?.synthesis" class="analysis-summary">
    <mat-card-header>
      <mat-icon mat-card-avatar class="text-purple-600 !text-3xl">insights</mat-icon>
      <mat-card-title>住 转 AI</mat-card-title>
      <mat-card-subtitle>{{ analysisResult?.timestamp | date:'dd/MM/yyyy HH:mm' }}</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content class="mt-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="metric-box">
          <span class="metric-label">爪</span>
          <span class="metric-value text-lg font-bold" [class]="getActionClass(analysisResult?.synthesis?.recommendation || '')">
            {{ analysisResult?.synthesis?.recommendation }}
          </span>
        </div>
        <div class="metric-box">
          <span class="metric-label"></span>
          <span class="metric-value text-lg font-bold text-blue-600">{{ analysisResult?.synthesis?.confidence }}%</span>
        </div>
        <div class="metric-box">
          <span class="metric-label">专转 住</span>
          <span class="metric-value text-lg font-bold" [class]="getRiskClass(analysisResult?.synthesis?.riskLevel || '')">
            {{ analysisResult?.synthesis?.riskLevel }}
          </span>
        </div>
      </div>
      
      <div class="executive-summary p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
        <h4 class="font-semibold mb-2 text-gray-900 dark:text-white">住 </h4>
        <p class="text-gray-700 dark:text-gray-300" dir="rtl">{{ analysisResult?.synthesis?.executiveSummary }}</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
