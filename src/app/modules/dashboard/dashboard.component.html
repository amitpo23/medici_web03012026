<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>
      <mat-icon>dashboard</mat-icon>
      Dashboard
    </h1>
    <div class="header-actions">
      <div class="date-range-selector">
        <button mat-stroked-button [class.mat-primary]="dateRange === 'today'" (click)="setDateRange('today')" type="button">
          Today
        </button>
        <button mat-stroked-button [class.mat-primary]="dateRange === 'week'" (click)="setDateRange('week')" type="button">
          Week
        </button>
        <button mat-stroked-button [class.mat-primary]="dateRange === 'month'" (click)="setDateRange('month')" type="button">
          Month
        </button>
        <button mat-stroked-button [class.mat-primary]="dateRange === 'quarter'" (click)="setDateRange('quarter')" type="button">
          Quarter
        </button>
        <button mat-stroked-button [class.mat-primary]="dateRange === 'year'" (click)="setDateRange('year')" type="button">
          Year
        </button>
        <button mat-stroked-button [class.mat-primary]="dateRange === 'all'" (click)="setDateRange('all')" type="button">
          All Time
        </button>
      </div>
      <button mat-raised-button color="primary" (click)="refreshData()" type="button">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <button class="action-btn" routerLink="/options" type="button">
      <mat-icon>add_circle</mat-icon>
      <span>New Opportunity</span>
    </button>
    <button class="action-btn" routerLink="/rooms" type="button">
      <mat-icon>hotel</mat-icon>
      <span>View Rooms</span>
    </button>
    <button class="action-btn" routerLink="/reports" type="button">
      <mat-icon>assessment</mat-icon>
      <span>Reports</span>
    </button>
    <button class="action-btn" routerLink="/reservation" type="button">
      <mat-icon>book_online</mat-icon>
      <span>Reservations</span>
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-spinner">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Loading dashboard data...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading" class="dashboard-content">

    <!-- Alerts Banner -->
    <div class="alerts-section" *ngIf="alerts.length > 0">
      <div class="alert-item" *ngFor="let alert of alerts" [ngClass]="'alert-' + alert.type">
        <mat-icon>{{ alert.type === 'warning' ? 'warning' : 'info' }}</mat-icon>
        <div class="alert-content">
          <strong>{{ alert.title }}</strong>
          <span>{{ alert.message }}</span>
        </div>
        <span class="alert-priority" [ngClass]="'priority-' + alert.priority">{{ alert.priority }}</span>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <!-- Total Revenue -->
      <div class="kpi-card revenue" role="region" aria-label="Total Revenue">
        <div class="kpi-header">
          <div class="kpi-icon revenue">
            <mat-icon>payments</mat-icon>
          </div>
          <div class="kpi-trend" [ngClass]="kpiData.revenueChange >= 0 ? 'positive' : 'negative'">
            <mat-icon>{{ kpiData.revenueChange >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
            {{ kpiData.revenueChange | number:'1.1-1' }}%
          </div>
        </div>
        <div class="kpi-value">{{ kpiData.totalRevenue | currency:'EUR':'symbol':'1.0-0' }}</div>
        <div class="kpi-label">Total Revenue</div>
      </div>

      <!-- Total Profit -->
      <div class="kpi-card profit" role="region" aria-label="Total Profit">
        <div class="kpi-header">
          <div class="kpi-icon profit">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="kpi-trend" [ngClass]="kpiData.profitMargin >= 10 ? 'positive' : 'negative'">
            <mat-icon>{{ kpiData.profitMargin >= 10 ? 'check_circle' : 'warning' }}</mat-icon>
            {{ kpiData.profitMargin | number:'1.1-1' }}% margin
          </div>
        </div>
        <div class="kpi-value">{{ kpiData.totalProfit | currency:'EUR':'symbol':'1.0-0' }}</div>
        <div class="kpi-label">Total Profit</div>
      </div>

      <!-- Active Bookings -->
      <div class="kpi-card bookings" role="region" aria-label="Active Bookings">
        <div class="kpi-header">
          <div class="kpi-icon bookings">
            <mat-icon>book</mat-icon>
          </div>
          <div class="kpi-trend positive">
            <mat-icon>sell</mat-icon>
            {{ kpiData.soldCount }} sold
          </div>
        </div>
        <div class="kpi-value">{{ kpiData.activeBookings | number }}</div>
        <div class="kpi-label">Active Bookings</div>
      </div>

      <!-- Conversion Rate -->
      <div class="kpi-card margin" role="region" aria-label="Conversion Rate">
        <div class="kpi-header">
          <div class="kpi-icon margin">
            <mat-icon>percent</mat-icon>
          </div>
          <div class="kpi-trend" [ngClass]="kpiData.conversionRate >= 50 ? 'positive' : 'negative'">
            <mat-icon>{{ kpiData.conversionRate >= 50 ? 'check_circle' : 'warning' }}</mat-icon>
            {{ kpiData.conversionRate >= 50 ? 'Good' : 'Low' }}
          </div>
        </div>
        <div class="kpi-value">{{ kpiData.conversionRate | number:'1.1-1' }}%</div>
        <div class="kpi-label">Conversion Rate</div>
      </div>
    </div>

    <!-- System Monitoring Widgets - NEW -->
    <div class="system-monitoring-widgets">
      <h2 class="section-title">
        <mat-icon>monitoring</mat-icon>
        System Monitoring
        <span class="section-subtitle">Real-time system health and alerts</span>
      </h2>

      <div class="monitoring-widgets-grid">
        <!-- System Health Widget -->
        <div class="monitoring-widget health-widget" [ngClass]="systemHealth.status">
          <div class="widget-header">
            <mat-icon class="widget-icon">{{ systemHealth.icon }}</mat-icon>
            <span class="widget-title">System Health</span>
          </div>
          <div class="widget-content">
            <div class="health-status">{{ systemHealth.text }}</div>
            <div class="health-details">
              <div class="health-metric">
                <span class="metric-label">Uptime:</span>
                <span class="metric-value">{{ systemHealth.uptime }}</span>
              </div>
              <div class="health-metric">
                <span class="metric-label">Response:</span>
                <span class="metric-value">{{ systemHealth.avgResponse }}ms</span>
              </div>
            </div>
          </div>
          <button mat-stroked-button class="widget-action" routerLink="/system/monitoring">
            View Details
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>

        <!-- Active Alerts Widget -->
        <div class="monitoring-widget alerts-widget" [class.has-alerts]="activeAlerts > 0">
          <div class="widget-header">
            <mat-icon class="widget-icon">{{ activeAlerts > 0 ? 'notification_important' : 'check_circle' }}</mat-icon>
            <span class="widget-title">Active Alerts</span>
          </div>
          <div class="widget-content">
            <div class="alert-count" [class.critical]="activeAlerts > 0">
              {{ activeAlerts }}
            </div>
            <div class="alert-breakdown" *ngIf="alertsBreakdown">
              <span class="breakdown-item critical" *ngIf="alertsBreakdown.critical > 0">
                üî¥ {{ alertsBreakdown.critical }} Critical
              </span>
              <span class="breakdown-item warning" *ngIf="alertsBreakdown.warning > 0">
                ‚ö†Ô∏è {{ alertsBreakdown.warning }} Warning
              </span>
              <span class="breakdown-item info" *ngIf="alertsBreakdown.info > 0">
                ‚ÑπÔ∏è {{ alertsBreakdown.info }} Info
              </span>
            </div>
            <div class="no-alerts" *ngIf="activeAlerts === 0">
              All systems operational ‚úÖ
            </div>
          </div>
          <button mat-stroked-button class="widget-action" routerLink="/system/alerts">
            View Alerts
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>

        <!-- Today's Revenue Widget -->
        <div class="monitoring-widget revenue-widget">
          <div class="widget-header">
            <mat-icon class="widget-icon">attach_money</mat-icon>
            <span class="widget-title">Today's Revenue</span>
          </div>
          <div class="widget-content">
            <div class="revenue-amount">{{ todayRevenue | currency:'EUR':'symbol':'1.0-0' }}</div>
            <div class="revenue-details">
              <div class="detail-row">
                <span class="detail-label">Profit:</span>
                <span class="detail-value positive">{{ todayProfit | currency:'EUR':'symbol':'1.0-0' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Margin:</span>
                <span class="detail-value">{{ todayMargin }}%</span>
              </div>
            </div>
          </div>
          <button mat-stroked-button class="widget-action" routerLink="/system/revenue">
            View Analytics
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- SEARCH INTELLIGENCE SECTION -->
    <div class="search-intelligence-section">
      <h2 class="section-title">
        <mat-icon>search</mat-icon>
        Search Intelligence
        <span class="section-subtitle">◊™◊ï◊ë◊†◊ï◊™ ◊û-8.3M ◊ó◊ô◊§◊ï◊©◊ô ◊ú◊ß◊ï◊ó◊ï◊™</span>
      </h2>
      
      <!-- Search Overview Cards -->
      <app-search-overview></app-search-overview>

      <!-- Top Cities and Hotels Row -->
      <div class="search-widgets-row">
        <app-search-top-cities></app-search-top-cities>
        <app-search-top-hotels></app-search-top-hotels>
      </div>
    </div>

    <!-- Forecast Summary -->
    <div class="forecast-section" *ngIf="forecast?.summary">
      <mat-card class="forecast-card">
        <mat-card-header>
          <mat-card-title>30-Day Forecast</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="forecast-stats">
            <div class="forecast-stat">
              <span class="forecast-value">{{ forecast!.summary.TotalExpectedRevenue | currency:'EUR':'symbol':'1.0-0' }}</span>
              <span class="forecast-label">Expected Revenue</span>
            </div>
            <div class="forecast-stat">
              <span class="forecast-value">{{ forecast!.summary.TotalExpectedProfit | currency:'EUR':'symbol':'1.0-0' }}</span>
              <span class="forecast-label">Expected Profit</span>
            </div>
            <div class="forecast-stat">
              <span class="forecast-value">{{ forecast!.summary.TotalBookings }}</span>
              <span class="forecast-label">Upcoming Bookings</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Revenue Trend</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <app-revenue-chart></app-revenue-chart>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Bookings by Hotel</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <app-occupancy-trend></app-occupancy-trend>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Top Hotels and Worker Status -->
    <div class="charts-row">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Top Performing Hotels</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="hotel-performance-list" *ngIf="topHotels.length > 0">
            <div class="hotel-perf-item" *ngFor="let hotel of topHotels">
              <div class="hotel-info">
                <span class="hotel-name">{{ hotel.HotelName }}</span>
                <span class="hotel-bookings">{{ hotel.TotalBookings }} bookings, {{ hotel.SoldCount }} sold</span>
              </div>
              <div class="hotel-metrics">
                <span class="hotel-profit" [ngClass]="hotel.Profit >= 0 ? 'positive' : 'negative'">
                  {{ hotel.Profit | currency:'EUR':'symbol':'1.0-0' }}
                </span>
                <span class="hotel-margin">{{ hotel.MarginPercent | number:'1.1-1' }}%</span>
              </div>
            </div>
          </div>
          <div *ngIf="topHotels.length === 0" class="no-data">No hotel data available</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>System Status</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="worker-status" *ngIf="workers">
            <div class="worker-item">
              <mat-icon [ngClass]="workers.buyroom.enabled ? 'status-ok' : 'status-off'">
                {{ workers.buyroom.enabled ? 'check_circle' : 'cancel' }}
              </mat-icon>
              <span>BuyRoom Worker</span>
              <span class="worker-badge" [ngClass]="workers.buyroom.enabled ? 'enabled' : 'disabled'">
                {{ workers.buyroom.enabled ? 'Active' : 'Disabled' }}
              </span>
            </div>
            <div class="worker-item">
              <mat-icon [ngClass]="workers.cancellation.enabled ? 'status-ok' : 'status-off'">
                {{ workers.cancellation.enabled ? 'check_circle' : 'cancel' }}
              </mat-icon>
              <span>Auto-Cancellation</span>
              <span class="worker-badge" [ngClass]="workers.cancellation.enabled ? 'enabled' : 'disabled'">
                {{ workers.cancellation.enabled ? 'Active' : 'Disabled' }}
              </span>
            </div>
            <div class="worker-item">
              <mat-icon [ngClass]="workers.priceUpdate.enabled ? 'status-ok' : 'status-off'">
                {{ workers.priceUpdate.enabled ? 'check_circle' : 'cancel' }}
              </mat-icon>
              <span>Price Update</span>
              <span class="worker-badge" [ngClass]="workers.priceUpdate.enabled ? 'enabled' : 'disabled'">
                {{ workers.priceUpdate.enabled ? 'Active' : 'Disabled' }}
              </span>
            </div>
          </div>

          <!-- Reservation Stats -->
          <div class="reservation-summary">
            <h4>Reservations</h4>
            <div class="res-stat">
              <span>Total:</span>
              <strong>{{ kpiData.totalReservations }}</strong>
            </div>
            <div class="res-stat">
              <span>Revenue:</span>
              <strong>{{ kpiData.reservationRevenue | currency:'EUR':'symbol':'1.0-0' }}</strong>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
