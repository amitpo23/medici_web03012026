<div class="workflows-container p-6 space-y-6">

  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
        <mat-icon class="text-indigo-600">account_tree</mat-icon>
        Workflows - Automated Decisions
      </h1>
      <p class="text-gray-500 dark:text-gray-400 mt-1">
        Manage decision rules, process opportunities, and review automation history
      </p>
    </div>
  </div>

  <!-- Tabs -->
  <mat-tab-group [(selectedIndex)]="selectedTabIndex" animationDuration="0ms">

    <!-- Tab 1: Decision Rules -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">rule</mat-icon>
        Decision Rules
      </ng-template>

      <div class="tab-content pt-4">
        <!-- Loading -->
        <div *ngIf="isLoadingRules" class="flex justify-center py-8">
          <mat-spinner diameter="40"></mat-spinner>
        </div>

        <!-- Empty state -->
        <div *ngIf="!isLoadingRules && rules.length === 0" class="text-center py-12 text-gray-500">
          <mat-icon class="empty-icon text-gray-300">rule_folder</mat-icon>
          <p class="mt-4 text-lg">No decision rules configured</p>
          <p class="text-sm text-gray-400">Rules will appear here once they are set up in the backend</p>
        </div>

        <!-- Rules list -->
        <div *ngIf="!isLoadingRules && rules.length > 0" class="rules-list space-y-3">
          <div class="flex justify-between items-center mb-4">
            <span class="text-sm text-gray-500">{{ rules.length }} rules configured</span>
            <button mat-stroked-button (click)="loadRules()" type="button">
              <mat-icon>refresh</mat-icon>
              Refresh
            </button>
          </div>

          <mat-card *ngFor="let rule of rules" class="rule-card">
            <mat-card-content>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <mat-slide-toggle
                    [checked]="rule.enabled"
                    (change)="toggleRule(rule)"
                    color="primary">
                  </mat-slide-toggle>
                  <div>
                    <div class="font-semibold text-gray-900 dark:text-white">{{ rule.name }}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                      ID: {{ rule.id }}
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="action-badge" [ngClass]="getActionClass(rule.action)">
                    {{ rule.action }}
                  </span>
                  <span class="status-badge"
                        [class.status-enabled]="rule.enabled"
                        [class.status-disabled]="!rule.enabled">
                    {{ rule.enabled ? 'Enabled' : 'Disabled' }}
                  </span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>

    <!-- Tab 2: Process Opportunity -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">play_circle</mat-icon>
        Process Opportunity
      </ng-template>

      <div class="tab-content pt-4">
        <mat-card class="process-card">
          <mat-card-header>
            <mat-card-title class="flex items-center gap-2">
              <mat-icon class="text-blue-600">bolt</mat-icon>
              Process Single Opportunity
            </mat-card-title>
            <mat-card-subtitle>
              Run a single opportunity through all enabled decision rules
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="flex flex-wrap items-end gap-4 mt-4">
              <mat-form-field appearance="outline" class="id-field">
                <mat-label>Opportunity ID</mat-label>
                <input matInput type="number" [(ngModel)]="opportunityId" placeholder="e.g. 12345">
                <mat-icon matPrefix>tag</mat-icon>
              </mat-form-field>
              <button mat-flat-button color="primary"
                      (click)="processOpportunity()"
                      [disabled]="isProcessing || opportunityId === null"
                      type="button">
                <mat-icon>play_arrow</mat-icon>
                Process
              </button>
            </div>

            <!-- Processing spinner -->
            <div *ngIf="isProcessing" class="flex justify-center py-6">
              <mat-spinner diameter="36"></mat-spinner>
            </div>

            <!-- Process result -->
            <mat-card *ngIf="processResult && !isProcessing" class="result-card mt-4">
              <mat-card-header>
                <mat-card-title class="text-lg">Processing Result</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="result-grid mt-3">
                  <div class="result-item">
                    <span class="result-label">Opportunity ID</span>
                    <span class="result-value">#{{ processResult.opportunityId }}</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Rule Applied</span>
                    <span class="result-value">{{ processResult.ruleName }}</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Action</span>
                    <span class="action-badge" [ngClass]="getActionClass(processResult.action)">
                      {{ processResult.action }}
                    </span>
                  </div>
                  <div class="result-item" *ngIf="processResult.details">
                    <span class="result-label">Details</span>
                    <span class="result-value">{{ processResult.details }}</span>
                  </div>
                  <div class="result-item" *ngIf="processResult.timestamp">
                    <span class="result-label">Timestamp</span>
                    <span class="result-value">{{ processResult.timestamp | date:'medium' }}</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Tab 3: Batch Process -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">dynamic_feed</mat-icon>
        Batch Process
      </ng-template>

      <div class="tab-content pt-4">
        <mat-card class="process-card">
          <mat-card-header>
            <mat-card-title class="flex items-center gap-2">
              <mat-icon class="text-purple-600">batch_prediction</mat-icon>
              Batch Process Opportunities
            </mat-card-title>
            <mat-card-subtitle>
              Enter multiple opportunity IDs separated by commas, spaces, or new lines
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="mt-4">
              <mat-form-field appearance="outline" class="batch-field w-full">
                <mat-label>Opportunity IDs</mat-label>
                <textarea matInput
                          [(ngModel)]="batchIdsText"
                          rows="4"
                          placeholder="e.g. 12345, 12346, 12347&#10;or one per line"></textarea>
              </mat-form-field>

              <div class="flex items-center justify-between mt-2">
                <span class="text-sm text-gray-500">
                  {{ getBatchIdCount() }} IDs detected
                </span>
                <button mat-flat-button color="primary"
                        (click)="batchProcess()"
                        [disabled]="isBatchProcessing || getBatchIdCount() === 0"
                        type="button">
                  <mat-icon>play_arrow</mat-icon>
                  Process Batch
                </button>
              </div>
            </div>

            <!-- Batch processing spinner -->
            <div *ngIf="isBatchProcessing" class="flex justify-center py-6">
              <mat-spinner diameter="36"></mat-spinner>
            </div>

            <!-- Batch result -->
            <div *ngIf="batchResult && !isBatchProcessing" class="mt-4">
              <mat-card class="result-card">
                <mat-card-header>
                  <mat-card-title class="text-lg">Batch Result</mat-card-title>
                  <mat-card-subtitle>
                    {{ batchResult.processed }} opportunities processed
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <!-- Errors if any -->
                  <div *ngIf="batchResult.errors && batchResult.errors.length > 0" class="errors-section mt-3 mb-3">
                    <div class="error-item" *ngFor="let error of batchResult.errors">
                      <mat-icon class="text-red-500 mr-2">error</mat-icon>
                      {{ error }}
                    </div>
                  </div>

                  <!-- Results table -->
                  <div class="overflow-x-auto" *ngIf="batchResult.results && batchResult.results.length > 0">
                    <table class="workflows-table w-full mt-3">
                      <thead>
                        <tr>
                          <th>Opportunity ID</th>
                          <th>Rule</th>
                          <th>Action</th>
                          <th>Details</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let item of batchResult.results">
                          <td class="font-semibold">#{{ item.opportunityId }}</td>
                          <td>{{ item.ruleName }}</td>
                          <td>
                            <span class="action-badge" [ngClass]="getActionClass(item.action)">
                              {{ item.action }}
                            </span>
                          </td>
                          <td>{{ item.details }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Tab 4: Decision History -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="mr-2">history</mat-icon>
        Decision History
      </ng-template>

      <div class="tab-content pt-4">
        <!-- Controls -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
          <div class="flex items-center gap-3">
            <mat-form-field appearance="outline" class="limit-field">
              <mat-label>Limit</mat-label>
              <mat-select [(ngModel)]="historyLimit" (selectionChange)="refreshHistory()">
                <mat-option [value]="25">25</mat-option>
                <mat-option [value]="50">50</mat-option>
                <mat-option [value]="100">100</mat-option>
                <mat-option [value]="250">250</mat-option>
                <mat-option [value]="500">500</mat-option>
              </mat-select>
            </mat-form-field>
            <span class="text-sm text-gray-500">{{ history.length }} records loaded</span>
          </div>
          <button mat-stroked-button (click)="refreshHistory()" [disabled]="isLoadingHistory" type="button">
            <mat-icon>refresh</mat-icon>
            Refresh
          </button>
        </div>

        <!-- Loading -->
        <div *ngIf="isLoadingHistory" class="flex justify-center py-8">
          <mat-spinner diameter="40"></mat-spinner>
        </div>

        <!-- Empty state -->
        <div *ngIf="!isLoadingHistory && history.length === 0" class="text-center py-12 text-gray-500">
          <mat-icon class="empty-icon text-gray-300">history_toggle_off</mat-icon>
          <p class="mt-4 text-lg">No decision history found</p>
          <p class="text-sm text-gray-400">History records will appear after opportunities are processed</p>
        </div>

        <!-- History table -->
        <mat-card *ngIf="!isLoadingHistory && history.length > 0">
          <mat-card-content>
            <div class="overflow-x-auto">
              <table mat-table [dataSource]="history" class="w-full">

                <!-- Timestamp Column -->
                <ng-container matColumnDef="timestamp">
                  <th mat-header-cell *matHeaderCellDef>Timestamp</th>
                  <td mat-cell *matCellDef="let row" class="whitespace-nowrap">
                    {{ row.timestamp | date:'short' }}
                  </td>
                </ng-container>

                <!-- Opportunity ID Column -->
                <ng-container matColumnDef="opportunityId">
                  <th mat-header-cell *matHeaderCellDef>Opportunity ID</th>
                  <td mat-cell *matCellDef="let row" class="font-semibold">
                    #{{ row.opportunityId }}
                  </td>
                </ng-container>

                <!-- Rule Name Column -->
                <ng-container matColumnDef="ruleName">
                  <th mat-header-cell *matHeaderCellDef>Rule</th>
                  <td mat-cell *matCellDef="let row">
                    {{ row.ruleName }}
                  </td>
                </ng-container>

                <!-- Action Column -->
                <ng-container matColumnDef="action">
                  <th mat-header-cell *matHeaderCellDef>Action</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="action-badge" [ngClass]="getActionClass(row.action)">
                      {{ row.action }}
                    </span>
                  </td>
                </ng-container>

                <!-- Details Column -->
                <ng-container matColumnDef="details">
                  <th mat-header-cell *matHeaderCellDef>Details</th>
                  <td mat-cell *matCellDef="let row">
                    {{ row.details }}
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="historyDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: historyDisplayedColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

  </mat-tab-group>

</div>
