<div class="trading-exchange">
  <!-- Top Bar -->
  <div class="exchange-header">
    <div class="header-left">
      <div class="medici-logo-badge">
        <span class="logo-text">MEDICI</span>
        <div class="stars">
          <span>★</span><span>★</span><span>★</span><span>★</span>
        </div>
      </div>
      <span class="tagline">World Trade Market</span>
    </div>
    <div class="header-center">
      <h1>Smart Room Trading Exchange</h1>
    </div>
    <div class="header-right">
      <div class="auto-refresh">
        <mat-slide-toggle
          [(ngModel)]="autoRefresh"
          color="primary"
        >
          Auto Refresh
        </mat-slide-toggle>
      </div>
      <button mat-icon-button (click)="refreshAll()" matTooltip="Refresh All" class="refresh-btn">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Main Layout with Hot Sale Sidebar -->
  <div class="exchange-layout">
    <!-- Left Panel - Market Analysis & Signals -->
    <div class="left-panel">
      <app-market-analysis-panel
        (hotelSelected)="onHotelSelected($event)"
      ></app-market-analysis-panel>
    </div>

    <!-- Center Panel -->
    <div class="center-panel">
      <!-- City/Hotel Selector Bar -->
      <div class="selector-bar">
        <mat-form-field appearance="outline" class="selector-field">
          <mat-label>City</mat-label>
          <mat-select [(value)]="selectedCity" (selectionChange)="onCityChange($event.value)">
            <mat-option value="">All Cities</mat-option>
            <mat-option *ngFor="let city of cities" [value]="city.cityName">
              {{ city.cityName }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>location_city</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="selector-field">
          <mat-label>Hotel</mat-label>
          <mat-select [(value)]="selectedHotelDropdownId" (selectionChange)="onHotelDropdownChange($event.value)">
            <mat-option [value]="0">All Hotels</mat-option>
            <mat-option *ngFor="let hotel of hotels" [value]="hotel.hotelId">
              {{ hotel.hotelName }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>hotel</mat-icon>
        </mat-form-field>
      </div>

      <!-- Demand Forecast Indicator -->
      <div class="demand-forecast-bar" *ngIf="demandForecast?.success && demandForecast?.analysis">
        <div class="forecast-header">
          <mat-icon>trending_up</mat-icon>
          <span class="forecast-title">Demand Forecast</span>
          <span class="forecast-city" *ngIf="selectedCity">{{ selectedCity }}</span>
        </div>
        <div class="forecast-metrics">
          <div class="forecast-metric" *ngIf="demandForecast.analysis.bookingVelocity">
            <span class="metric-label">Velocity</span>
            <span class="metric-value">
              {{ demandForecast.analysis.bookingVelocity.daily || '0' }}/day
            </span>
          </div>
          <div class="forecast-metric" *ngIf="demandForecast.analysis.bookingVelocity">
            <span class="metric-label">Trend</span>
            <span class="metric-value trend"
                  [class.up]="demandForecast.analysis.bookingVelocity.trend === 'accelerating'"
                  [class.down]="demandForecast.analysis.bookingVelocity.trend === 'decelerating'">
              {{ demandForecast.analysis.bookingVelocity.trend || 'stable' }}
            </span>
          </div>
          <div class="forecast-metric" *ngIf="demandForecast.analysis.hotPeriods?.length">
            <span class="metric-label">Hot Period</span>
            <span class="metric-value hot">
              {{ demandForecast.analysis.hotPeriods[0]?.month || 'N/A' }}
            </span>
          </div>
          <div class="forecast-metric" *ngIf="demandForecast.analysis.searchVelocity">
            <span class="metric-label">Search Activity</span>
            <span class="metric-value">
              {{ demandForecast.analysis.searchVelocity.daily || '0' }}/day
            </span>
          </div>
        </div>
        <div class="forecast-recommendation" *ngIf="demandForecast.analysis.recommendation">
          <mat-icon>lightbulb</mat-icon>
          <span>{{ demandForecast.analysis.recommendation }}</span>
        </div>
      </div>
      <div class="forecast-loading" *ngIf="demandLoading">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Loading forecast...</span>
      </div>

      <!-- Trade Table Section -->
      <div class="trade-table-section">
        <!-- Filter Row -->
        <div class="table-filters">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Min Profit ($)</mat-label>
            <input matInput type="number" [(ngModel)]="minProfit"
                   (ngModelChange)="onMinProfitChange($event)" placeholder="0">
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Period</mat-label>
            <mat-select [(value)]="periodFilter" (selectionChange)="onPeriodFilterChange($event.value)">
              <mat-option value="all">All Periods</mat-option>
              <mat-option value="0-7">Short-term (0-7d)</mat-option>
              <mat-option value="7-30">Medium (7-30d)</mat-option>
              <mat-option value="30-60">Long (30-60d)</mat-option>
              <mat-option value="60+">Extended (60+d)</mat-option>
            </mat-select>
          </mat-form-field>

          <span class="filter-count">{{ filteredOpportunities.length }} opportunities</span>
        </div>

        <!-- Enhanced Table -->
        <table class="trade-table">
          <thead>
            <tr>
              <th>Hotel</th>
              <th>City</th>
              <th>Check-in</th>
              <th>Days</th>
              <th>Room</th>
              <th>Buy</th>
              <th>Sell</th>
              <th>Profit</th>
              <th>Margin</th>
              <th>Confidence</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredOpportunities; let i = index"
                [class.selected]="selectedIndex === i"
                (click)="selectOpportunity(i, item)">
              <td>{{ item.hotelName }}</td>
              <td>{{ item.city }}</td>
              <td>{{ item.checkIn | date:'dd/MM' }}</td>
              <td>
                <span class="days-badge"
                      [class.urgent]="item.daysToCheckIn <= 7"
                      [class.soon]="item.daysToCheckIn > 7 && item.daysToCheckIn <= 30">
                  {{ item.daysToCheckIn }}d
                </span>
              </td>
              <td>{{ item.roomType }}</td>
              <td>{{ item.price | number:'1.0-0' }}$</td>
              <td class="sell-price">{{ item.originalPrice | number:'1.0-0' }}$</td>
              <td [class.positive]="item.expectedProfit > 0"
                  [class.negative]="item.expectedProfit <= 0">
                {{ item.expectedProfit > 0 ? '+' : '' }}{{ item.expectedProfit | number:'1.0-0' }}$
              </td>
              <td>
                <span class="margin-badge"
                      [class.good]="item.marginPercent >= 15"
                      [class.ok]="item.marginPercent >= 5 && item.marginPercent < 15">
                  {{ item.marginPercent }}%
                </span>
              </td>
              <td>
                <div class="confidence-pill"
                     [style.background]="getConfidenceColor(item.confidence)">
                  {{ item.confidence }}%
                </div>
              </td>
              <td>
                <button class="btn-gold" (click)="onBuyOpportunity(item); $event.stopPropagation()">
                  <mat-icon>shopping_cart</mat-icon>
                  Buy
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredOpportunities.length === 0">
              <td colspan="11" class="empty-row">
                No opportunities match your filters
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- AI Trading Signals -->
      <div class="trading-signals-section">
        <app-trading-signals
          (signalSelected)="onSignalSelected($event)"
          (buyClicked)="onBuySignal($event)"
        ></app-trading-signals>
      </div>

      <!-- Insights Section with Charts -->
      <div class="insights-section">
        <app-insights-chart
          [hotelId]="selectedHotelId"
          [city]="selectedCity || (selectedHotelName ? '' : 'TLV')"
          [height]="220"
        ></app-insights-chart>

        <app-price-chart
          #priceChart
          [hotelId]="selectedHotelId"
          [height]="250"
        ></app-price-chart>
      </div>

      <!-- ML Analysis Panel -->
      <div class="ml-analysis-section">
        <app-ml-analysis-panel
          [initialCity]="selectedCity"
          [initialHotelId]="selectedHotelId"
          (hotelSelected)="onHotelSelected($event)"
        ></app-ml-analysis-panel>
      </div>

      <!-- Order Book -->
      <div class="order-book-container">
        <app-order-book
          #orderBook
          [hotelId]="selectedHotelId"
          [levels]="10"
        ></app-order-book>
      </div>
    </div>

    <!-- Right Panel - Hot Sale Sidebar -->
    <app-hot-sale-sidebar
      (hotelSelected)="onHotSaleHotelSelected($event)"
      (searchRequested)="onSearchRequested($event)"
    ></app-hot-sale-sidebar>
  </div>

  <!-- Bottom Panel -->
  <div class="bottom-actions">
    <a mat-stroked-button routerLink="portfolio" class="action-btn portfolio-btn">
      <mat-icon>account_balance_wallet</mat-icon>
      View Full Portfolio
    </a>
    <a mat-stroked-button routerLink="/trading/search" class="action-btn search-btn">
      <mat-icon>search</mat-icon>
      Search & Buy
    </a>
    <a mat-stroked-button routerLink="/trading/inventory" class="action-btn inventory-btn">
      <mat-icon>inventory_2</mat-icon>
      Manage Inventory
    </a>
  </div>
</div>
